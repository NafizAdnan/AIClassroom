{% extends "base_generic.html" %}
{% block content %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Session</title>

    <!-- Tailwind CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.2.1/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

</head>

<div class="container mx-auto p-4">
    <div class="flex justify-between">
        <h2 class="text-2xl font-bold">{{ session.exam.title }}</h2>
        <div id="webcam-container" class="w-32 h-24 border rounded overflow-hidden">
            <video id="webcam" autoplay class="w-full h-full object-cover"></video>
        </div>
    </div>

    <div class="mt-2">
        <p><strong>Started At:</strong> {{ session.started_at }}</p>
        <p><strong>Time Remaining:</strong> <span id="countdown" class="font-mono text-lg">{{ countdown }}</span></p>
    </div>

    <div class="mt-4">
        <form method="post" action="{% url 'submit_exam' session.session_token %}">
            {% csrf_token %}
            {% for question in questions %}
            <div class="mb-4 p-4 border rounded bg-white">
                <h5 class="text-lg font-semibold">{{ question.question_text }}</h5>
                {% if question.question_type == 'multiple_choice' %}
                    {% for opt in question.choices.splitlines %}
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="question_{{ question.id }}" value="{{ opt }}" id="opt{{ forloop.counter }}">
                        <label class="form-check-label" for="opt{{ forloop.counter }}">{{ opt }}</label>
                    </div>
                    {% endfor %}
                {% elif question.question_type == 'true_false' %}
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="question_{{ question.id }}" value="True" id="true{{ question.id }}">
                        <label class="form-check-label" for="true{{ question.id }}">True</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="question_{{ question.id }}" value="False" id="false{{ question.id }}">
                        <label class="form-check-label" for="false{{ question.id }}">False</label>
                    </div>
                {% elif question.question_type == 'short_answer' or question.question_type == 'long_answer' %}
                    {% if question.question_type == 'short_answer' %}
                        <textarea class="form-control" name="question_{{ question.id }}" rows="3"></textarea>
                    {% else %}
                        <textarea class="form-control" name="question_{{ question.id }}" rows="5"></textarea>
                    {% endif %}
                {% elif question.question_type == 'fill_in_the_blank' %}
                    <input type="text" class="form-control border rounded w-full p-2" name="question_{{ question.id }}">
                {% endif %}
            </div>
            {% endfor %}
            <button type="submit" class="btn btn-primary bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Submit Exam</button>
        </form>
    </div>

    <!-- Logging Details -->
    <div id="logging-details" class="fixed bottom-4 right-4 w-64 h-32 overflow-y-auto bg-gray-800 text-white text-xs p-2 rounded">
        <!-- Logging details will be dynamically added here -->
    </div>
</div>

<script>
    const video = document.getElementById('webcam');

    // Access the webcam
    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
            video.srcObject = stream;
        })
        .catch(error => {
            console.error("Webcam access denied", error);
        });

    // Function to capture an image from the video stream
    function captureImage() {
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const context = canvas.getContext('2d');
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        // Convert the captured image to a data URL
        const dataUrl = canvas.toDataURL('image/png');

        // Send the image to the server
        fetch("{% url 'capture_image' session.session_token %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ image: dataUrl })
        });
    }

    // Capture an image every 60 seconds
    setInterval(captureImage, 60000);

    // Countdown timer
    function startCountdown(duration) {
        let timer = duration, minutes, seconds;
        setInterval(function () {
            minutes = parseInt(timer / 60, 10);
            seconds = parseInt(timer % 60, 10);

            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;

            document.getElementById('countdown').textContent = minutes + ":" + seconds;

            if (--timer < 0) {
                timer = 0;
                alert("Time is up!");
                document.querySelector('form').submit();
            }
        }, 1000);
    }

    // Start the countdown
    startCountdown({{ countdown }});

    // Detect when the exam page loses focus (student switches tabs)
    window.onblur = function() {
        alert("You are not allowed to switch tabs during the exam!");
        
        // Log the event (Optional)
        fetch("{% url 'log_focus_loss' session.session_token %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        }).then(response => response.json())
          .then(data => {
              const logContainer = document.getElementById('logging-details');
              logContainer.innerHTML += `<p>Focus lost at ${new Date().toLocaleTimeString()}</p>`;
          });
    };

    // Prevent right-click and key combinations like Ctrl+S, Ctrl+C, Ctrl+V
    document.addEventListener('contextmenu', event => event.preventDefault());
    document.addEventListener('keydown', function(event) {
        if (event.ctrlKey || event.key === 'F12' || event.key === 'PrintScreen') {
            event.preventDefault();
        }
    });
</script>
{% endblock content %}